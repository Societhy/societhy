

\section*{Synopsis}

A hybrid streaming middleware kernel backwards compatible with connect.

\section*{Motivation}

The advantage to streaming middlewares is that they do not require buffering the entire stream in order to execute their function.

\section*{Status}

\href{http://travis-ci.org/flatiron/union}{\tt }

\section*{Installation}

There are a few ways to use {\ttfamily union}. Install the library using npm. You can add it to your {\ttfamily package.\+json} file as a dependancy


\begin{DoxyCode}
$ [sudo] npm install union
\end{DoxyCode}


\subsection*{Usage}

Union\textquotesingle{}s request handling is \href{https://github.com/senchalabs/connect}{\tt connect}-\/compatible, meaning that all existing connect middlewares should work out-\/of-\/the-\/box with union.

$\ast$$\ast$(Union 0.\+3.\+x is compatible with connect $>$= 2.\+1.\+0, \href{https://github.com/pksunkara/connect-union}{\tt Extensively Tested})$\ast$$\ast$

In addition, the response object passed to middlewares listens for a \char`\"{}next\char`\"{} event, which is equivalent to calling {\ttfamily next()}. Flatiron middlewares are written in this manner, meaning they are not reverse-\/compatible with connect.

\subsubsection*{A simple case}


\begin{DoxyCode}
var fs = require('fs'),
    union = require('../lib'),
    director = require('director');

var router = new director.http.Router();

var server = union.createServer(\{
  before: [
    function (req, res) \{
      var found = router.dispatch(req, res);
      if (!found) \{
        res.emit('next');
      \}
    \}
  ]
\});

router.get(/foo/, function () \{
  this.res.writeHead(200, \{ 'Content-Type': 'text/plain' \})
  this.res.end('hello world\(\backslash\)n');
\});

router.post(/foo/, \{ stream: true \}, function () \{
  var req = this.req,
      res = this.res,
      writeStream;

  writeStream = fs.createWriteStream(Date.now() + '-foo.txt');
  req.pipe(writeStream);

  writeStream.on('close', function () \{
    res.writeHead(200, \{ 'Content-Type': 'text/plain' \});
    res.end('wrote to a stream!');
  \});
\});

server.listen(9090);
console.log('union with director running on 9090');
\end{DoxyCode}


To demonstrate the code, we use \href{https://github.com/flatiron/director}{\tt director}. A light-\/weight, Client A\+ND Server side U\+R\+L-\/\+Router for Node.\+js and Single Page Apps!

\subsubsection*{A case with connect}

Code based on connect


\begin{DoxyCode}
var connect = require('connect')
  , http = require('http');

var app = connect()
  .use(connect.favicon())
  .use(connect.logger('dev'))
  .use(connect.static('public'))
  .use(connect.directory('public'))
  .use(connect.cookieParser('my secret here'))
  .use(connect.session())
  .use(function (req, res) \{
    res.end('Hello from Connect!\(\backslash\)n');
  \});

http.createServer(app).listen(3000);
\end{DoxyCode}


Code based on union


\begin{DoxyCode}
var connect = require('connect')
  , union = require('union');

var server = union.createServer(\{
  buffer: false,
  before: [
    connect.favicon(),
    connect.logger('dev'),
    connect.static('public'),
    connect.directory('public'),
    connect.cookieParser('my secret here'),
    connect.session(),
    function (req, res) \{
      res.end('Hello from Connect!\(\backslash\)n');
    \},
  ]
\}).listen(3000);
\end{DoxyCode}


\subsubsection*{S\+P\+DY enabled server example}

\section*{A\+PI}

\subsection*{union Static Members}

\subsubsection*{create\+Server(options)}

The {\ttfamily options} object is required. Options include\+:

Specification


\begin{DoxyCode}
function createServer(options)

@param options \{Object\}
An object literal that represents the configuration for the server.

  @option before \{Array\}
  The `before` value is an array of middlewares, which are used to route and serve incoming
  requests. For instance, in the example, `favicon` is a middleware which handles requests
  for `/favicon.ico`.

  @option after \{Array\}
  The `after` value is an array of functions that return stream filters,
  which are applied after the request handlers in `options.before`.
  Stream filters inherit from `union.ResponseStream`, which implements the
  Node.js core streams api with a bunch of other goodies.

  @option limit \{Object\}
  (optional) A value, passed to internal instantiations of `union.BufferedStream`.

  @option https \{Object\}
  (optional) A value that specifies the certificate and key necessary to create an instance of
  `https.Server`.

  @option spdy \{Object\}
  (optional) A value that specifies the certificate and key necessary to create an instance of
  `spdy.Server`.

  @option headers \{Object\}
  (optional) An object representing a set of headers to set in every outgoing response
\end{DoxyCode}


Example


\begin{DoxyCode}
var server = union.createServer(\{
  before: [
    favicon('./favicon.png'),
    function (req, res) \{
      var found = router.dispatch(req, res);
      if (!found) \{
        res.emit('next');
      \}
    \}
  ]
\});
\end{DoxyCode}


An example of the {\ttfamily https} or {\ttfamily spdy} option.


\begin{DoxyCode}
\{
  cert: 'path/to/cert.pem',
  key: 'path/to/key.pem',
  ca: 'path/to/ca.pem'
\}
\end{DoxyCode}


An example of the {\ttfamily headers} option.


\begin{DoxyCode}
\{
  'x-powered-by': 'your-sweet-application v10.9.8'
\}
\end{DoxyCode}


\subsection*{Error Handling}

Error handler is similiar to middlware but takes an extra argument for error at the beginning.


\begin{DoxyCode}
var handle = function (err, req, res) \{
  res.statusCode = err.status;
  res.end(req.headers);
\};

var server = union.createServer(\{
  onError: handle,
  before: [
    favicon('./favicon.png'),
    function (req, res) \{
      var found = router.dispatch(req, res);
      if (!found) \{
        res.emit('next');
      \}
    \}
  ]
\});
\end{DoxyCode}


\subsection*{Buffered\+Stream Constructor}

This constructor inherits from {\ttfamily Stream} and can buffer data up to {\ttfamily limit} bytes. It also implements {\ttfamily pause} and {\ttfamily resume} methods.

Specification


\begin{DoxyCode}
function BufferedStream(limit)

@param limit \{Number\}
the limit for which the stream can be buffered
\end{DoxyCode}


Example


\begin{DoxyCode}
var bs = union.BufferedStream(n);
\end{DoxyCode}


\subsection*{Http\+Stream Constructor}

This constructor inherits from {\ttfamily union.\+Buffered\+Stream} and returns a stream with these extra properties\+:

Specification


\begin{DoxyCode}
function HttpStream()
\end{DoxyCode}


Example


\begin{DoxyCode}
var hs = union.HttpStream();
\end{DoxyCode}


\subsection*{Http\+Stream Instance Members}

\subsubsection*{url}

The url from the request.

Example


\begin{DoxyCode}
httpStream.url = '';
\end{DoxyCode}


\subsubsection*{headers}

The H\+T\+TP headers associated with the stream.

Example


\begin{DoxyCode}
httpStream.headers = '';
\end{DoxyCode}


\subsubsection*{method}

The H\+T\+TP method (\char`\"{}\+G\+E\+T\char`\"{}, \char`\"{}\+P\+O\+S\+T\char`\"{}, etc).

Example


\begin{DoxyCode}
httpStream.method = 'POST';
\end{DoxyCode}


\subsubsection*{query}

The querystring associated with the stream (if applicable).

Example


\begin{DoxyCode}
httpStream.query = '';
\end{DoxyCode}


\subsection*{Response\+Stream Constructor}

This constructor inherits from {\ttfamily union.\+Http\+Stream}, and is additionally writeable. Union supplies this constructor as a basic response stream middleware from which to inherit.

Specification


\begin{DoxyCode}
function ResponseStream()
\end{DoxyCode}


Example


\begin{DoxyCode}
var rs = union.ResponseStream();
\end{DoxyCode}


\section*{Tests}

All tests are written with \href{http://vowsjs.org}{\tt vows} and should be run with \href{http://npmjs.org}{\tt npm}\+:


\begin{DoxyCode}
$ npm test
\end{DoxyCode}


\section*{Licence}

(The M\+IT License)

Copyright (c) 2010-\/2012 Nodejitsu Inc. \href{http://www.twitter.com/nodejitsu}{\tt http\+://www.\+twitter.\+com/nodejitsu}

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \textquotesingle{}Software\textquotesingle{}), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions\+:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

T\+HE S\+O\+F\+T\+W\+A\+RE IS P\+R\+O\+V\+I\+D\+ED \textquotesingle{}AS IS\textquotesingle{}, W\+I\+T\+H\+O\+UT W\+A\+R\+R\+A\+N\+TY OF A\+NY K\+I\+ND, E\+X\+P\+R\+E\+SS OR I\+M\+P\+L\+I\+ED, I\+N\+C\+L\+U\+D\+I\+NG B\+UT N\+OT L\+I\+M\+I\+T\+ED TO T\+HE W\+A\+R\+R\+A\+N\+T\+I\+ES OF M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY, F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE A\+ND N\+O\+N\+I\+N\+F\+R\+I\+N\+G\+E\+M\+E\+NT. IN NO E\+V\+E\+NT S\+H\+A\+LL T\+HE A\+U\+T\+H\+O\+RS OR C\+O\+P\+Y\+R\+I\+G\+HT H\+O\+L\+D\+E\+RS BE L\+I\+A\+B\+LE F\+OR A\+NY C\+L\+A\+IM, D\+A\+M\+A\+G\+ES OR O\+T\+H\+ER L\+I\+A\+B\+I\+L\+I\+TY, W\+H\+E\+T\+H\+ER IN AN A\+C\+T\+I\+ON OF C\+O\+N\+T\+R\+A\+CT, T\+O\+RT OR O\+T\+H\+E\+R\+W\+I\+SE, A\+R\+I\+S\+I\+NG F\+R\+OM, O\+UT OF OR IN C\+O\+N\+N\+E\+C\+T\+I\+ON W\+I\+TH T\+HE S\+O\+F\+T\+W\+A\+RE OR T\+HE U\+SE OR O\+T\+H\+ER D\+E\+A\+L\+I\+N\+GS IN T\+HE S\+O\+F\+T\+W\+A\+RE. 