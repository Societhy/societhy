# base image is debian
FROM ubuntu:latest

RUN apt-get update -y &&  \
	apt-get upgrade -qy && \
	apt-get dist-upgrade -qy && \
	apt-get install software-properties-common -qy

# set container dependencies as environment variable:
# DEPENDENCIES are to be installed with apt-get
# PIP_PACKAGES are to be installed with pip3 (python packages)

# languages
ENV DEPENDENCIES="python3 python3-pip python-virtualenv libssl-dev curl file binutils make git ethminer"

# libraries and services
ENV DEPENDENCIES="$DEPENDENCIES mongodb supervisor"

ENV HOME="/societhy"

RUN add-apt-repository -y ppa:ethereum/ethereum && \
    add-apt-repository -y ppa:ethereum/ethereum-dev && \
    apt-get update -y

RUN apt-get install $DEPENDENCIES -qy

# python packages
ENV PIP_PACKAGES="$PIP_PACKAGES flask ipfsapi openpyxl pyJWT pytest pillow qrcode requests"

RUN pip3 install $PIP_PACKAGES

RUN pip3 install ethereum --upgrade

# INSTALL our own ethjsonrpc module

RUN git clone https://github.com/simonvadee/ethjsonrpc.git && \
        cd ethjsonrpc && \
        git pull && \
        python3 setup.py install && \
        cp -r ethjsonrpc /usr/local/lib/python3.5/dist-packages/ethjsonrpc

# INSTALL latest (py3) mongokat module

RUN git clone https://github.com/pricingassistant/mongokat.git && \
    cd mongokat && \
    git pull && \
    python3 setup.py install && \
    cp -r mongokat /usr/local/lib/python3.5/dist-packages/mongokat

RUN echo 'alias run="python3 app/app.py"' >> ~/.bashrc

ENV MONGOIP="127.0.0.1"

ENV ETHIP="127.0.0.1"

ENV ETHPORT=8545

ENV PYTHONPATH="/societhy/app"

ENV KEYS_DIRECTORY="/societhy/.parity/keys"

# add code files and setup work directory
WORKDIR /societhy

COPY ./utils /societhy/utils

RUN bash /societhy/utils/install_parity.sh

EXPOSE 8080

EXPOSE 22

RUN cd /societhy/utils ; ./install.sh
